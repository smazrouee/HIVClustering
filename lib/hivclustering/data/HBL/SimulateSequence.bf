site_rates = {{0,0,0,0,0,2,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,2,0,2,0,0,1,2,1,1,2,0,0,0,2,1,2,0,0,0,1,1,0,0,1,0,0,2,2,1,1,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,1,0,1,0,0,1,0,0,2,1,0,2,2,2,1,1,0,2,1,1,0,0,0,2,0,2,1,0,0,0,0,1,1,0,0,0,0,1,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,1,1,0,0,1,0,0,0,0,0,2,1,0,1,2,0,1,2,2,2,2,0,1,0,0,1,0,0,2,0,0,1,0,0,2,1,0,1,0,1,1,1,1,1,1,1,1,0,0,1,0,0,0,0,0,2,1,0,1,2,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,0,0,0,0,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,1,0,1,2,0,0,0,0,2,0,0,1,0,0,1,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,1,1,1,0,1,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,1,0,0,1,0,2,1,0,0,1,0,0,1,0,0,1,0,0,0,0,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,1,0,1,2,1,1,0,0,1,0,0,1,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,0,0,1,0,0,1,0,0,2,0,0,1,0,0,1,1,0,1,0,1,1,1,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,1,0,1,0,0,0,0,0,2,0,0,0,0,1,1,0,0,1,0,0,2,0,0,1,1,0,1,0,1,1,0,0,1,0,0,0,0,0,1,0,0,1,1,0,1,0,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,2,1,0,0,1,0,0,1,0,0,2,0,0,1,0,0,0,0,0,1,1,0,2,0,0,1,1,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,2,1,0,1,0,0,1,1,0,1,1,1,1,1,1,0,0,1,2,0,1,1,0,0,0,0,0,1,0,0,0,0,0,1,1,0,2,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,2,0,0,1,1,0,1,0,0,2,1,0,1,1,0,1,2,1,1,1,1,2,0,0,1,0,0,2,0,0,1,0,0,1,0,0,1,0,0,1,0,0,2,0,0,1,0,0,1,0,0,1,0,0,1,2,2,1,0,0,1,0,0,0,0,1,1,0,0,1,0,0,1,0,0,2,1,1,1,0,0,2,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,2,0,0,1,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,0,1,2,1,1,0,0,1,0,0,0,0,1,1,0,1,1,0,0,1,1,0,1,0,0,2,0,0,1,0,0,1,0,0,1,1,1,1,1,1,2,0,0,1,0,0,1,1,0,2,1,0,2,1,1,2,0,0,1,0,1,1,0,0,1,0,0,1,1,0,0,0,0,0,0,0,1,1,0,1,0,0,0,0,0,0,0,0,1,0,0,1,0,0,1,1,0,1,0,0,1,1,0,0,0,2,2,1,0,1,0,0,1,0,0,1,2,1,1,0,0,1,1,0,0,0,0,1,0,0,1,1,0,2,0,0,1,2,1,2,0,0,1,1,0,1,1,1,1,1,2,2,0,0,0,0,0,2,1,0,2,1,1,1,0,0,1,0,0,0,0,0,1,1,0,1,0,0,2,0,0,1,0,0,1,0,0,1,0,0,1,0,0,2,0,0,1,0,0,2,0,1,1,0,0,0,0,0,0,0,0,2,0,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,1,0,0,1,1,0,1,2,2,2,1,0,1,0,0,0,1,0,2,1,0,2,0,0,2,1,1,1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,1,1,0,0,0,0,1,0,0,1,0,0,1,1,0,2,0,0,1,0,0,0,0,0,1,0,0,1,0,0,1,0,0,2,0,0,2,2,1,0,0,0,2,0,0,1,0,1,1,1,0,1,0,2,2,1,0,2,1,0,1,0,0,1,0,1,1,0,0,1,1,0,1,0,1,1,0,0,1,2,0,1,0,0,1,1,0,1,2,0,1,0,0,0,0,0,2,1,0,1,2,0,1,1,0,1,1,0,1,0,0,1,2,2,1,0,0,1,0,0,0,0,0,2,1,0,1,0,0,1,1,0,2,0,1,0,0,0,1,0,0,1,0,0,1,0,0,2,0,0,0,1,0,1,0,1,1,1,1,2,0,0,1,0,0,1,0,0,0,0,0,2,0,1,2,0,0,2,0,0,0,0,0,1,1,0,1,2,0,1,0,0,1,1,1,2,1,0,1,1,0,0,0,1,0,0,0,1,2,0,0,0,0,0,0,0,1,0,0,1,0,1,1,2,2,2,1,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}};
rate_values = {{0.044159,1.456920,5.453997}};

TRY_NUMERIC_SEQUENCE_MATCH = 1;

function defineModel () {
    global AC:=0.2171371138076576;
    global AT:=0.09455823878956798;
    global CG:=0.1082814068731988;
    global GT:=0.1089456956632179;
    global CT:=1.167132112771781;
    
    GRM={4,4};
    GRM[0][1]:=AC*mu;
    GRM[0][2]:=mu;
    GRM[0][3]:=AT*mu;
    GRM[1][0]:=AC*mu;
    GRM[1][2]:=CG*mu;
    GRM[1][3]:=CT*mu;
    GRM[2][0]:=mu;
    GRM[2][1]:=CG*mu;
    GRM[2][3]:=GT*mu;
    GRM[3][0]:=AT*mu;
    GRM[3][1]:=CT*mu;
    GRM[3][2]:=GT*mu;


    vectorOfFrequencies={
    {0.3572325696826894}
    {0.1854362804881559}
    {0.2219376526639096}
    {0.235393497165245}
    }
    ;
    
    Model GRMModel=(GRM,vectorOfFrequencies);

    return 0;


}

AUTOMATICALLY_CONVERT_BRANCH_LENGTHS = 1;

//_baseline_sequence  = "CCTCAAATCACTCTTTGGCAACGACCCATCGTCACAATAAAGATAGGAGGGCAACTAAGGGAAGCTCTATTAGACACAGGAGCAGATGATACAGTATTAGAAGACATAAGTTTGCCAGGAAGATGGAAACCAAAGATGATAGGGGGAATTGGAGGTTTTGTCAAAGTAAAACAGTATGATCAGATACCCATAGAAATCTGTGGACATAAAGTTATAGGTACAGTATTAGTAGGACCTACACCTGTCAACGTAATTGGAAGAAATCTGATGACTCAGCTTGGTTGCACTTTAAATTTTCCCATTAGTCCTATTGAAACTGTACCAGTAAAATTAAAGCCAGGAATGGATGGCCCAAGAGTCAAACAATGGCCATTGACAGAAGAAAAAATAAAAGCATTAGTAGAAATTTGTGCAGAACTGGAAAAGGAAGGAAAAATTTCAAAAATTGGGCCTGAAAATCCATACAATACTCCAATATTTGCTATAAAGAAAAAGAACAGCACGAAATGGAGAAAATTAGTAGATTTCAGAGAACTTAATAAGAGAACTCAAGACTTCTGGGAAGTTCAATTAGGAATACCACATCCCGCAGGGTTACCAAAGAACAAGTCAGTAACAGTACTGGATGTGGGTGATGCATATTTTTCAGTTCCCTTAGATAAAGACTTCAGGAAGTACACTGCATTTACCATACCTAGTATAAACAATGAGACACCAGGGATTAGATATCAGTACAATGTGCTTCCACAGGGATGGAAAGGATCACCAGCAATATTCCAAAGTAGCATGACAAAAATCTTAGAGCCTTTCAGAAAACAAAACCCAGATATAGTTATCTACCAATACATGGATGATTTGTATGTAGGATCTGACTTAGAAATAGGGCAGCATAGAACAAAAGTAGAGGAACTGAGACAACATCTGTTGAAGTGGGGATTTTACACACCAGACAAAAAACATCAGAAAGAACCTCCATTCCTTTGGATGGGTTATGAACTCCATCCAGATAAATGGACAGTACAGCCTATAGTGCTGCCAGAAAAAGACAGCTGGACTGTCAATGACATACAGAAGTTAGTGGGAAAATTGAATTGGGCAAGTCAGATTTACCCAGGGATTAAAGTAAAGCAATTATGTAAACTCCTTAGAGGAACCAAATCACTAACAGAAGTAATACCACTAACAGAAGAGGCAGAGCTAGAGCTGGCAGAAAACAGGGAGATTCTAAAACAACCAGTACATGGAGTGTATTATGACCCATCAAAAGACTTAATAGCAGAATTACAGAAGCAGGAGCAAGGC";
//_desired_divergence = 0.01;


defineModel ();

ExecuteCommands ("Tree T = (1:" + _desired_divergence + ",2:" + _desired_divergence+")");
base_rate = T.2.mu;

nuc_chars = {{"A","C","G","T"}{"1","","",""}};

rate_count = Columns (rate_values);

base_strings     = {1, rate_count};
sim_strings      = {1, rate_count};
counters         = {1, rate_count};

for (ri = 0; ri < rate_count; ri += 1) {
    
    base_string = ""; base_string * 128;
    for (ci = 0; ci < Abs (_baseline_sequence); ci+=1) {
        if (site_rates[ci] == ri) {
            base_string * (_baseline_sequence[ci]);
        }
    }
    base_string * 0;
    T.2.mu = base_rate*rate_values[ri];
    //fprintf (stdout, Format (T, 1,1), "\n");
    DataSet       sim_seq    = Simulate (T,vectorOfFrequencies,nuc_chars, base_string);
    DataSetFilter sim_filter = CreateFilter (sim_seq, 1);
    GetDataInfo (info, sim_filter, 1);
    sim_strings [ri] = info;
}

_returnstring = ""; _returnstring * 128; 

for (ci = 0; ci < Abs (_baseline_sequence); ci+=1) {
    ri = site_rates[ci];
    _returnstring * ((sim_strings[ri])[counters[ri]]);
    counters[ri] += 1;
}


_returnstring * 0; 

/*fprintf (stdout, _returnstring, "\n");
fprintf (stdout, ">1\n" + _baseline_sequence + "\n>2\n" + _returnstring, "\n");
DataSet simD = ReadFromString (">1\n" + _baseline_sequence + "\n>2\n" + _returnstring);
LikelihoodFunction lf_sim = (sim_filter, T);
Optimize (res, lf_sim);
fprintf (stdout, lf_sim,"\n", base_rate, "\n", T.2.mu, "\n");*/


function _THyPhyAskFor(key)
{
    if (key == "_derived_sequence") {
        return _returnstring;
    }
    

    
    return "_THyPhy_NOT_HANDLED_";
}
